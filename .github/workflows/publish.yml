name: Publish Docker Container

on:
  workflow_dispatch:

jobs:
  publish-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # to push tags/releases
      packages: write   # to publish to GHCR

    steps:
      # Step 0: Checkout repository with full history (needed for tags)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 1: Determine new version from last tag
      - name: Get latest tag
        id: get_latest_tag
        run: |
          git fetch --tags
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
          # Remove 'v' prefix if present
          latest_tag=${latest_tag#v}
          echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT

      - name: Increment version
        id: increment_version
        run: |
          IFS='.' read -r major minor patch <<< "${{ steps.get_latest_tag.outputs.latest_tag }}"
          patch=$((patch + 1))
          new_tag="$major.$minor.$patch"
          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT
          echo "New version: $new_tag"

      # Step 2: Create Git tag and release
      - name: Create Git tag & release
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag v${{ steps.increment_version.outputs.new_tag }}
          git push origin v${{ steps.increment_version.outputs.new_tag }}
          # Create GitHub release
          gh release create v${{ steps.increment_version.outputs.new_tag }} \
            --title "Release v${{ steps.increment_version.outputs.new_tag }}" \
            --notes "Automated release of version v${{ steps.increment_version.outputs.new_tag }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 3: Build the Java application
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn clean package -DskipTests

      # Step 4: Login to GitHub Container Registry
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Step 5: Convert repository name to lowercase
      - name: Convert repository name to lowercase
        id: repo_lc
        run: echo "name=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      # Step 6: Build and push Docker image
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/${{ steps.repo_lc.outputs.name }}:${{ steps.increment_version.outputs.new_tag }}
            ghcr.io/${{ steps.repo_lc.outputs.name }}:latest